workflow: session-insights-dev
description: Development workflow for session-insights CLI tool with failure diagnosis

agents:
  - role: engineer
  - role: reviewer

states:
  start:
    type: initial
    auto_transition: engineering

  engineering:
    instructions: |
      Implement the assigned task for the session-insights CLI tool.

      FAILURE GATE (do this FIRST, before writing any code):
      Check whether this exact task has failed in a previous cycle. If it has:
      1. Read the failure logs from the previous attempt.
      2. Identify the SPECIFIC root cause (not just "test failed").
      3. Write a 2-3 sentence diagnosis explaining what went wrong.
      4. Only proceed if you have a DIFFERENT approach than what was tried before.
      5. If you cannot identify a different approach, signal "blocked" with your
         diagnosis so the mission can escalate rather than waste another cycle.

      KNOWN BLOCKER — negative-path-cli-tests:
      This task has failed across 5+ cycles. Before attempting it:
      - Verify the CLI entry point exists and is importable
      - Verify Click test runner (CliRunner) works with a trivial command first
      - Check that all test fixtures and dependencies are available
      - If ANY of these preconditions fail, signal "blocked" with specifics
      Do NOT just re-run the same tests and hope they pass.

      TASK ALIGNMENT CHECK:
      Identify which KPI(s) this task will move. If you cannot name at least one
      of the KPIs below that this task directly advances, STOP and signal blocked
      with an explanation.

      KPIs (updated after cycle 4 — 68% overall):
      - note_content_richness: 0% — CRITICAL, #1 priority
      - vermas_task_visibility: 65% — needs edge-case handling
      - cli_runs_clean: 85% — needs negative-path tests
      - obsidian_compatibility: on track

      MANDATORY PRIORITY: note_content_richness is at 0%. If your current task
      does not address this KPI and there are available tasks that do, request
      a task swap by signaling blocked with the reason "higher-priority KPI task
      available."

      ESCALATION RULE: If you attempt a task and it fails, do NOT retry it in
      the same cycle. Signal "blocked" with a root cause analysis. The system
      will escalate after 3 cumulative failures of the same task across cycles.

      Follow Python best practices:
      - Use Pydantic v2 for models
      - Click for CLI commands
      - pytest for testing
      - Type hints throughout

      Run tests before signaling done:
      `uv run pytest tests/ -x -q`

      If tests fail, fix them before signaling. If you cannot fix them after
      two attempts, signal "blocked" with the error output.

      Signal "done" when implementation is complete and tests pass.
      Signal "blocked" if you encounter infrastructure issues or cannot make
      progress (see failure gate above).
    on_signal:
      done:
        from: engineer
        next: reviewing
      blocked:
        from: engineer
        next: blocked
    timeout:
      duration: 30m
      action: nudge

  reviewing:
    instructions: |
      Review the engineer's implementation for the session-insights CLI tool.

      REVIEW FOCUS AREAS:
      1. Does the code actually work? Run `uv run pytest tests/ -x -q`
      2. Are there type errors? Run `uv run mypy` on changed files
      3. Does it advance the claimed KPI? Verify the connection is real.
      4. For CLI-related changes: test both happy path AND error paths manually

      QUALITY GATE:
      - Tests must pass
      - No type errors
      - Code follows existing patterns in the codebase
      - New tests cover the added functionality

      If changes need revision, signal "needs_revision" with specific feedback.
      If changes look good and tests pass, signal "approved".
    on_signal:
      approved:
        from: reviewer
        next: finalize
      needs_revision:
        from: reviewer
        next: engineering
    timeout:
      duration: 15m
      action: nudge

  finalize:
    on_entry:
      - action: commit
    type: terminal

  blocked:
    on_entry:
      - action: log
        message: >
          Workflow blocked. Check agent diagnosis for root cause.
          If this task has failed 3+ times across cycles, escalate to human review.
          Consider closing the mission at current completion % if remaining tasks
          are non-critical.
    type: terminal
