workflow: session-insights-dev
description: Development workflow for session-insights CLI tool with failure diagnosis

agents:
  - role: engineer
  - role: reviewer

states:
  start:
    type: initial
    auto_transition: engineering

  engineering:
    instructions: |
      Implement the assigned task for the session-insights CLI tool.
      
      PRIORITY ORDER (address in this order unless task specifies otherwise):
      1. Wire real data into existing CLI command skeletons (vermas_task_visibility)
      2. Implement note generation/enrichment logic (note_content_richness - 0% and critical)
      3. Add end-to-end CLI invocation tests (cli_runs_clean)
      4. New features or commands only after above are functional
      
      CRITICAL: NO MORE SCAFFOLDING
      The CLI skeleton and parser are complete and stable. Do NOT create new command
      stubs or placeholder implementations. All work must produce functional code that
      operates on real data. If your task involves a CLI command, verify it displays
      actual task state, not stub/placeholder output.
      
      CRITICAL: CLI TASK HANDLING
      CLI tasks have historically high failure rates (>50%). If your task involves CLI:
      1. DECOMPOSE into layers: argument parsing, dispatch logic, business logic
      2. Implement and test each layer separately before integration
      3. If blocked on CLI infrastructure after 2 attempts, signal "blocked" immediately
      4. Do NOT retry the same failing approach - signal blocked for human review
      
      CRITICAL: NOTE CONTENT RICHNESS
      If your task relates to note generation or content enrichment:
      - This KPI has been at 0% for 5+ cycles and is the single biggest risk
      - Implement the simplest functional version first (even if minimal)
      - A working minimal implementation beats an ambitious incomplete one
      
      Follow Python best practices:
      - Use Pydantic v2 for models
      - Click for CLI commands
      - pytest for testing
      - Type hints throughout
      
      Run tests before signaling done:
      `uv run pytest tests/ -x -q`
      
      Also run at least one end-to-end CLI invocation test:
      `uv run python -m session_insights <command> --help`
      Verify the command runs without error and produces meaningful output.
      
      If tests fail, fix them before signaling.
      
      Signal "done" when implementation is complete and tests pass.
      Signal "blocked" if you encounter infrastructure issues or are stuck after 2 attempts.
    on_signal:
      done:
        from: engineer
        next: reviewing
      blocked:
        from: engineer
        next: blocked
    timeout:
      duration: 30m
      action: nudge

  reviewing:
    instructions: |
      Review the engineer's implementation for the session-insights CLI tool.
      
      REVIEW CHECKLIST (must verify all):
      1. Code operates on REAL DATA, not stubs or placeholders
      2. CLI commands produce meaningful output when invoked
      3. Tests exist and pass: `uv run pytest tests/ -x -q`
      4. At least one end-to-end CLI invocation succeeds with real output
      5. Type hints present, Pydantic v2 models used where appropriate
      6. No regressions in existing functionality
      
      SPECIAL ATTENTION:
      - If the task touches note_content_richness: verify notes contain actual
        enriched content, not template/placeholder text
      - If the task touches vermas_task_visibility: verify CLI shows real task
        state from the system, not hardcoded examples
      
      Signal "approved" if all checks pass.
      Signal "needs_revision" with specific feedback if issues found.
      Be specific about what needs to change - vague feedback causes retry loops.
    on_signal:
      approved:
        from: reviewer
        next: finalize
      needs_revision:
        from: reviewer
        next: engineering
    timeout:
      duration: 15m
      action: nudge

  finalize:
    on_entry:
      - action: commit
    type: terminal

  blocked:
    on_entry:
      - action: log
        message: "Workflow blocked - engineer stuck after multiple attempts or infrastructure issue. Requires manual intervention."
    type: terminal
