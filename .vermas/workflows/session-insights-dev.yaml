workflow: session-insights-dev
description: Development workflow for session-insights CLI tool

agents:
  - role: engineer
  - role: reviewer

states:
  start:
    type: initial
    auto_transition: validate

  validate:
    instructions: |
      CRITICAL: Before implementing ANYTHING, validate the execution environment.
      This validation MUST pass before any implementation work begins.
      
      Run these checks IN ORDER and report ALL failures:
      
      1. Verify Python environment:
         `uv run python --version`
         Expected: Python 3.11 or higher
      
      2. Verify project structure exists:
         - Check if pyproject.toml exists in the project root
         - Check if src/ directory exists
         - If pyproject.toml is missing, signal "blocked" immediately
      
      3. Verify dependencies can be installed:
         `uv sync`
         If this fails, signal "blocked" with the error message
      
      4. Verify pytest works:
         `uv run pytest --version`
      
      5. Run a trivial test to prove execution works:
         `uv run python -c "print('Environment OK')"`
      
      If ALL checks pass, signal "done".
      
      If ANY check fails:
      - Report the SPECIFIC error message in your signal
      - Signal "blocked" - do NOT proceed to implementation
      - Include diagnostic info: which step failed, the exact error output
    on_signal:
      done:
        from: engineer
        next: engineering
      blocked:
        from: engineer
        next: blocked
    timeout:
      duration: 10m
      action: escalate

  engineering:
    instructions: |
      Implement the assigned task for the session-insights CLI tool.
      
      IMPORTANT: If you encounter any environment or tooling errors, 
      signal "blocked" immediately with the error details. Do not retry.
      
      Follow Python best practices:
      - Use Pydantic v2 for models
      - Click for CLI commands
      - pytest for testing
      - Type hints throughout
      
      Run tests before signaling done:
      `uv run pytest tests/ -x -q`
      
      Signal "done" when implementation is complete and tests pass.
      Signal "blocked" if you encounter infrastructure or environment issues.
    on_signal:
      done:
        from: engineer
        next: reviewing
      blocked:
        from: engineer
        next: blocked
    timeout:
      duration: 30m
      action: nudge

  reviewing:
    instructions: |
      Review the implementation for correctness and quality.
      
      Verification steps:
      1. Read all changed files
      2. Run full test suite with coverage
      3. Test CLI manually if applicable
      4. Check for edge cases and error handling
      
      Signal "approved" if quality is acceptable.
      Signal "needs_revision" with specific feedback if changes needed.
    on_signal:
      approved:
        from: reviewer
        next: finalize
      needs_revision:
        from: reviewer
        next: engineering
    timeout:
      duration: 15m
      action: nudge

  blocked:
    type: terminal
    on_entry:
      - action: log
        message: Workflow blocked - environment validation failed or infrastructure issue detected. Manual intervention required.

  finalize:
    type: terminal
    on_entry:
      - action: commit
