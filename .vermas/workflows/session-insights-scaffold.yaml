agents:
- role: engineer
- role: reviewer
states:
  blocked:
    on_entry:
    - action: log
      message: Workflow blocked - environment validation failed or infrastructure
        issue
    type: terminal
  engineering:
    instructions: 'Implement the assigned task for the session-insights CLI tool.


      Follow Python best practices:

      - Use Pydantic v2 for models

      - Click for CLI commands

      - pytest for testing

      - Type hints throughout


      Run tests before signaling done:

      `uv run pytest tests/ -x -q`


      If tests fail, fix them before signaling.


      Signal "done" when implementation is complete and tests pass.

      Signal "blocked" if you encounter infrastructure issues.

      '
    on_signal:
      blocked:
        from: engineer
        next: blocked
      done:
        from: engineer
        next: reviewing
    timeout:
      action: nudge
      duration: 30m
  finalize:
    on_entry:
    - action: commit
    type: terminal
  reviewing:
    instructions: 'Review the implementation for correctness and quality.


      Verification steps:

      1. Read all changed files

      2. Run full test suite with coverage

      3. Test CLI manually if applicable

      4. Check for edge cases and error handling


      Signal "approved" if quality is acceptable.

      Signal "needs_revision" with specific feedback if changes needed.

      '
    on_signal:
      approved:
        from: reviewer
        next: finalize
      needs_revision:
        from: reviewer
        next: engineering
    timeout:
      action: nudge
      duration: 15m
  start:
    auto_transition: validate
    type: initial
  validate:
    instructions: "Before implementing anything, validate the execution environment.\n\
      \nRun these checks IN ORDER and report any failures:\n\n1. Verify Python environment:\n\
      \   `uv run python --version`\n   Expected: Python 3.11 or higher\n\n2. Verify\
      \ project structure exists:\n   - Check if pyproject.toml exists\n   - Check\
      \ if src/ directory exists\n   - If pyproject.toml is missing, this project\
      \ needs setup first\n\n3. Verify dependencies can be installed:\n   `uv sync`\n\
      \n4. Verify pytest works:\n   `uv run pytest --version`\n\nIf ALL checks pass,\
      \ signal \"done\".\n\nIf ANY check fails:\n- Report the specific failure in\
      \ your signal message\n- Signal \"blocked\" with details about what failed\n"
    on_signal:
      blocked:
        from: engineer
        next: blocked
      done:
        from: engineer
        next: engineering
    timeout:
      action: fail
      duration: 5m
workflow: session-insights-scaffold
